<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Settings</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .frame {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2em;
            margin: 2em auto;
            max-width: 400px;
            text-align: center;
        }
        h1 { color: #333; }
        nav {
            background: #222;
            color: #fff;
            padding: 0.5em 1em;
            display: flex;
            align-items: center;
        }
        nav div {
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 2em;
        }
        nav a {
            color: #fff;
            text-decoration: none;
            margin-right: 1.5em;
            padding: 0.5em 1em;
            border-radius: 4px;
        }
        nav a:hover {
            background: #444;
        }
        nav a.active {
            background: #444;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #0078d7;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #overlay {
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100vw;
            height:100vh;
            background:rgba(255,255,255,0.8);
            z-index:9999;
            align-items:center;
            justify-content:center;
        }
        .update-section {
            margin-top: 2em;
            text-align: left;
        }
        .update-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .update-section th, .update-section td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .update-section th {
            background-color: #f2f2f2;
            text-align: left;
        }
    </style>
</head>
<body>
    <nav>
        <div>RPI Encoder</div>
        <a href="/" class="{% if active_tab == 'home' %}active{% endif %}">Home</a>
        <a href="/camera-viewer" class="{% if active_tab == 'camera' %}active{% endif %}">Camera Viewer</a>
        <a href="/settings-page" class="{% if active_tab == 'settings' %}active{% endif %}">Settings</a>
        <a href="/system-settings" class="{% if active_tab == 'system_settings' %}active{% endif %}">System Settings</a>
    </nav>
    <div class="frame">
        <h1>System Settings</h1>
        <form id="auth-form">
            <h2>Basic Authentication</h2>
            <label>Username: <input type="text" id="auth-username" name="username" required></label><br><br>
            <label>Password: <input type="password" id="auth-password" name="password" required>
                <input type="checkbox" id="toggle-auth-pass" style="margin-left:0.5em;"> Show
            </label><br><br>
            <button type="submit">Save Auth Settings</button>
            <span id="auth-result" style="margin-left:1em;"></span>
        </form>
        <hr>
        <form id="wifi-form">
            <h2>WiFi Settings</h2>
            <label>SSID: <input type="text" id="wifi-ssid" name="ssid" required></label><br><br>
            <label>Password: <input type="password" id="wifi-pass" name="wifi_password" required>
                <input type="checkbox" id="toggle-wifi-pass" style="margin-left:0.5em;"> Show
            </label><br><br>
            <button type="submit">Save WiFi Settings</button>
            <span id="wifi-result" style="margin-left:1em;"></span>
        </form>
        <hr>
        <button id="reboot-btn" style="background:#d33;color:#fff;padding:0.5em 2em;border:none;border-radius:4px;font-weight:bold;">Reboot System</button>
        <span id="reboot-result" style="margin-left:1em;"></span>
        <hr>
        <div class="update-section">
            <button id="check-update-btn" style="background:#0078d7;color:#fff;padding:0.5em 2em;border:none;border-radius:4px;font-weight:bold;">Check for Updates</button>
            <button id="do-update-btn" style="display:none;background:#28a745;color:#fff;padding:0.5em 2em;border:none;border-radius:4px;font-weight:bold;margin-top:1em;">Update Now</button>
            <div id="update-status" style="margin-top:10px;"></div>
            <div id="update-details" style="margin-top:10px;"></div>
        </div>
    </div>
    <div id="overlay">
        <div style="display:flex;flex-direction:column;align-items:center;">
            <div class="spinner"></div>
            <div style="margin-top:1em;font-size:1.2em;color:#333;">Rebooting... Please wait</div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load current auth settings
        fetch('/system-settings-data').then(r => r.json()).then(data => {
            if (data.auth) {
                document.getElementById('auth-username').value = data.auth.username || '';
                document.getElementById('auth-password').value = data.auth.password || '';
            }
            if (data.wifi) {
                document.getElementById('wifi-ssid').value = data.wifi.ssid || '';
                document.getElementById('wifi-pass').value = data.wifi.password || '';
            }
        });
        // Auth form submit
        document.getElementById('auth-form').onsubmit = function(e) {
            e.preventDefault();
            fetch('/system-settings-auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: document.getElementById('auth-username').value,
                    password: document.getElementById('auth-password').value
                })
            }).then(r => r.json()).then(data => {
                document.getElementById('auth-result').textContent = data.success ? 'Saved!' : (data.error || 'Error');
                document.getElementById('auth-result').style.color = data.success ? 'green' : 'red';
            });
        };
        // WiFi form submit
        document.getElementById('wifi-form').onsubmit = function(e) {
            e.preventDefault();
            fetch('/system-settings-wifi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ssid: document.getElementById('wifi-ssid').value,
                    password: document.getElementById('wifi-pass').value
                })
            }).then(r => r.json()).then(data => {
                document.getElementById('wifi-result').textContent = data.success ? 'Saved!' : (data.error || 'Error');
                document.getElementById('wifi-result').style.color = data.success ? 'green' : 'red';
            });
        };
        // Reboot button
        document.getElementById('reboot-btn').onclick = function() {
            if (!confirm('Are you sure you want to reboot the system?')) return;
            fetch('/system-settings-reboot', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {
                    if (data.success) {
                        // Show overlay and start polling
                        document.getElementById('overlay').style.display = 'flex';
                        setTimeout(function pollForReload() {
                            fetch(window.location.href, {cache: 'no-store'})
                                .then(r => {
                                    if (r.ok) {
                                        window.location.reload();
                                    } else {
                                        setTimeout(pollForReload, 2000);
                                    }
                                })
                                .catch(() => setTimeout(pollForReload, 2000));
                        }, 5000); // Wait 5s before first poll
                    } else {
                        document.getElementById('reboot-result').textContent = data.error || 'Error';
                        document.getElementById('reboot-result').style.color = 'red';
                    }
                });
        };
        // Check for Updates button
        var checkUpdateBtn = document.getElementById('check-update-btn');
        var updateStatus = document.getElementById('update-status');
        var updateDetails = document.getElementById('update-details');
        var doUpdateBtn = document.getElementById('do-update-btn');
        if (checkUpdateBtn) {
            checkUpdateBtn.onclick = function() {
                updateStatus.textContent = 'Checking for updates...';
                updateDetails.innerHTML = '';
                fetch('/system-check-update', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            updateStatus.textContent = data.summary;
                            if (data.updates && data.updates.length > 0) {
                                let html = '<table class="table table-sm table-bordered" style="margin-top:10px;">';
                                html += '<thead><tr><th>File</th><th>Action</th><th>Detail</th></tr></thead><tbody>';
                                data.updates.forEach(u => {
                                    html += `<tr><td>${u.filename}</td><td>${u.action}</td><td>${u.detail}</td></tr>`;
                                });
                                html += '</tbody></table>';
                                updateDetails.innerHTML = html;
                                doUpdateBtn.style.display = 'inline-block';
                            } else {
                                updateDetails.innerHTML = '';
                                doUpdateBtn.style.display = 'none';
                            }
                        } else {
                            updateStatus.textContent = data.error || 'Update check failed.';
                            updateDetails.innerHTML = '';
                            doUpdateBtn.style.display = 'none';
                        }
                    })
                    .catch(e => {
                        updateStatus.textContent = 'Update check failed.';
                        updateDetails.innerHTML = '';
                        doUpdateBtn.style.display = 'none';
                    });
            };
        }
        if (doUpdateBtn) {
            doUpdateBtn.onclick = function() {
                doUpdateBtn.disabled = true;
                updateStatus.textContent = 'Updating...';
                updateDetails.innerHTML = '';
                fetch('/system-do-update', { method: 'POST' })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.success) {
                            updateStatus.textContent = 'Update complete! Please reboot the system.';
                            if (data.results && data.results.length > 0) {
                                let html = '<div style="margin-top:10px;"><b>Update Results:</b><ul>';
                                data.results.forEach(function(res) {
                                    html += `<li>${res}</li>`;
                                });
                                html += '</ul></div>';
                                updateDetails.innerHTML = html;
                            } else {
                                updateDetails.innerHTML = '';
                            }
                        } else {
                            updateStatus.textContent = data.error || 'Update failed.';
                            updateDetails.innerHTML = '';
                        }
                        doUpdateBtn.disabled = false;
                    })
                    .catch(function(e) {
                        updateStatus.textContent = 'Update failed.';
                        updateDetails.innerHTML = '';
                        doUpdateBtn.disabled = false;
                    });
            };
        }
        // Password visibility toggles
        document.getElementById('toggle-auth-pass').onchange = function() {
            document.getElementById('auth-password').type = this.checked ? 'text' : 'password';
        };
        document.getElementById('toggle-wifi-pass').onchange = function() {
            document.getElementById('wifi-pass').type = this.checked ? 'text' : 'password';
        };
    });
    </script>
</body>
</html>
